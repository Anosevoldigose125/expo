{"version":3,"file":"plugin-resolver.js","names":["_assert","data","_interopRequireDefault","require","path","_interopRequireWildcard","_resolveFrom","_errors","_modules","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","obj","pluginFileName","exports","resolvePluginForModule","projectRoot","pluginReference","resolvedPackageJson","resolveFrom","silent","resolvedPluginScriptFile","hasResolved","throwPluginNotFound","PluginError","moduleNameIsDirectFileReference","isPluginFile","filePath","maybePluginFilePath","findUpPlugin","pathIsFilePath","name","match","slashCount","split","sep","length","startsWith","resolveExpoPluginFile","root","pluginModuleFile","fileExists","rootPackageJsonPath","moduleRoot","dirname","normalizeStaticPlugin","plugin","Array","isArray","assert","undefined","assertInternalProjectRoot","resolveConfigPluginFunction","resolveConfigPluginFunctionWithInfo","pluginFile","result","requirePluginFile","error","SyntaxError","learnMoreLink","pluginError","message","stack","resolveConfigPluginExport"],"sources":["../../src/utils/plugin-resolver.ts"],"sourcesContent":["import assert from 'assert';\nimport * as path from 'path';\nimport resolveFrom from 'resolve-from';\n\nimport { PluginError } from './errors';\nimport { fileExists } from './modules';\nimport { ConfigPlugin, StaticPlugin } from '../Plugin.types';\n\n// Default plugin entry file name.\nexport const pluginFileName = 'app.plugin.js';\n\n// pluginReference is a node module or a file path, as user entered it in app.config.js\nexport function resolvePluginForModule(\n  projectRoot: string,\n  pluginReference: string\n): { filePath: string; isPluginFile: boolean } {\n  const resolvedPackageJson = resolveFrom.silent(projectRoot, `${pluginReference}/package.json`);\n  const resolvedPluginScriptFile = resolveFrom.silent(projectRoot, pluginReference);\n  const hasResolved = !!(resolvedPackageJson || resolvedPluginScriptFile);\n\n  function throwPluginNotFound(): never {\n    throw new PluginError(\n      `Failed to resolve plugin for module \"${pluginReference}\" relative to \"${projectRoot}\"`,\n      'PLUGIN_NOT_FOUND'\n    );\n  }\n  if (!hasResolved) {\n    throwPluginNotFound();\n  }\n  // If the pluginReference is something like `@bacon/package/index.js` or `expo-foo/build/app`\n  // then skip resolving the module `app.plugin.js`\n  if (moduleNameIsDirectFileReference(pluginReference) && resolvedPluginScriptFile) {\n    return { isPluginFile: false, filePath: resolvedPluginScriptFile };\n  }\n  if (!resolvedPackageJson) {\n    throwPluginNotFound();\n  }\n  const maybePluginFilePath = findUpPlugin(resolvedPackageJson);\n  if (maybePluginFilePath) {\n    return { isPluginFile: true, filePath: maybePluginFilePath };\n  } else {\n    if (!resolvedPluginScriptFile) {\n      throwPluginNotFound();\n    }\n    return { isPluginFile: false, filePath: resolvedPluginScriptFile };\n  }\n}\n\n// TODO: Test windows\nfunction pathIsFilePath(name: string): boolean {\n  // Matches lines starting with: . / ~/\n  return !!name.match(/^(\\.|~\\/|\\/)/g);\n}\n\nexport function moduleNameIsDirectFileReference(name: string): boolean {\n  if (pathIsFilePath(name)) {\n    return true;\n  }\n\n  const slashCount = name.split(path.sep)?.length;\n  // Orgs (like @expo/config ) should have more than one slash to be a direct file.\n  if (name.startsWith('@')) {\n    return slashCount > 2;\n  }\n\n  // Regular packages should be considered direct reference if they have more than one slash.\n  return slashCount > 1;\n}\n\nfunction resolveExpoPluginFile(root: string): string | null {\n  // Find the expo plugin root file\n  const pluginModuleFile = resolveFrom.silent(\n    root,\n    // use ./ so it isn't resolved as a node module\n    `./${pluginFileName}`\n  );\n\n  // If the default expo plugin file exists use it.\n  if (pluginModuleFile && fileExists(pluginModuleFile)) {\n    return pluginModuleFile;\n  }\n  return null;\n}\n\nfunction findUpPlugin(rootPackageJsonPath: string): string | null {\n  // resolve the rootPackageJsonPath folder for the node module\n  const moduleRoot = path.dirname(rootPackageJsonPath);\n  // use whatever the initial resolved file was ex: `node_modules/my-package/index.js` or `./something.js`\n  return resolveExpoPluginFile(moduleRoot);\n}\n\nexport function normalizeStaticPlugin(plugin: StaticPlugin | ConfigPlugin | string): StaticPlugin {\n  if (Array.isArray(plugin)) {\n    assert(\n      plugin.length > 0 && plugin.length < 3,\n      `Wrong number of arguments provided for static config plugin, expected either 1 or 2, got ${plugin.length}`\n    );\n    return plugin;\n  }\n  return [plugin, undefined];\n}\n\nexport function assertInternalProjectRoot(projectRoot?: string): asserts projectRoot {\n  assert(\n    projectRoot,\n    `Unexpected: Config \\`_internal.projectRoot\\` isn't defined by expo-cli, this is a bug.`\n  );\n}\n\n// Resolve the module function and assert type\nexport function resolveConfigPluginFunction(projectRoot: string, pluginReference: string) {\n  const { plugin } = resolveConfigPluginFunctionWithInfo(projectRoot, pluginReference);\n  return plugin;\n}\n\n// Resolve the module function and assert type\nexport function resolveConfigPluginFunctionWithInfo(projectRoot: string, pluginReference: string) {\n  const { filePath: pluginFile, isPluginFile } = resolvePluginForModule(\n    projectRoot,\n    pluginReference\n  );\n  let result: any;\n  try {\n    result = requirePluginFile(pluginFile);\n  } catch (error) {\n    if (error instanceof SyntaxError) {\n      const learnMoreLink = `Learn more: https://docs.expo.dev/guides/config-plugins/#creating-a-plugin`;\n      // If the plugin reference is a node module, and that node module has a syntax error, then it probably doesn't have an official config plugin.\n      if (!isPluginFile && !moduleNameIsDirectFileReference(pluginReference)) {\n        const pluginError = new PluginError(\n          `Package \"${pluginReference}\" does not contain a valid config plugin.\\n${learnMoreLink}\\n\\n${error.message}`,\n          'INVALID_PLUGIN_IMPORT'\n        );\n        pluginError.stack = error.stack;\n        throw pluginError;\n      }\n    }\n    throw error;\n  }\n\n  const plugin = resolveConfigPluginExport({\n    plugin: result,\n    pluginFile,\n    pluginReference,\n    isPluginFile,\n  });\n  return { plugin, pluginFile, pluginReference, isPluginFile };\n}\n\n/**\n * - Resolve the exported contents of an Expo config (be it default or module.exports)\n * - Assert no promise exports\n * - Return config type\n * - Serialize config\n *\n * @param props.plugin plugin results\n * @param props.pluginFile plugin file path\n * @param props.pluginReference the string used to reference the plugin\n * @param props.isPluginFile is file path from the app.plugin.js module root\n */\nexport function resolveConfigPluginExport({\n  plugin,\n  pluginFile,\n  pluginReference,\n  isPluginFile,\n}: {\n  plugin: any;\n  pluginFile: string;\n  pluginReference: string;\n  isPluginFile: boolean;\n}): ConfigPlugin<unknown> {\n  if (plugin.default != null) {\n    plugin = plugin.default;\n  }\n  if (typeof plugin !== 'function') {\n    const learnMoreLink = `Learn more: https://docs.expo.dev/guides/config-plugins/#creating-a-plugin`;\n    // If the plugin reference is a node module, and that node module does not export a function then it probably doesn't have a config plugin.\n    if (!isPluginFile && !moduleNameIsDirectFileReference(pluginReference)) {\n      throw new PluginError(\n        `Package \"${pluginReference}\" does not contain a valid config plugin. Module must export a function from file: ${pluginFile}\\n${learnMoreLink}`,\n        'INVALID_PLUGIN_TYPE'\n      );\n    }\n    throw new PluginError(\n      `Plugin \"${pluginReference}\" must export a function from file: ${pluginFile}. ${learnMoreLink}`,\n      'INVALID_PLUGIN_TYPE'\n    );\n  }\n\n  return plugin;\n}\n\nfunction requirePluginFile(filePath: string): any {\n  try {\n    return require(filePath);\n  } catch (error) {\n    // TODO: Improve error messages\n    throw error;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;AAAA,SAAAA,QAAA;EAAA,MAAAC,IAAA,GAAAC,sBAAA,CAAAC,OAAA;EAAAH,OAAA,YAAAA,CAAA;IAAA,OAAAC,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAG,KAAA;EAAA,MAAAH,IAAA,GAAAI,uBAAA,CAAAF,OAAA;EAAAC,IAAA,YAAAA,CAAA;IAAA,OAAAH,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAK,aAAA;EAAA,MAAAL,IAAA,GAAAC,sBAAA,CAAAC,OAAA;EAAAG,YAAA,YAAAA,CAAA;IAAA,OAAAL,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAEA,SAAAM,QAAA;EAAA,MAAAN,IAAA,GAAAE,OAAA;EAAAI,OAAA,YAAAA,CAAA;IAAA,OAAAN,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAO,SAAA;EAAA,MAAAP,IAAA,GAAAE,OAAA;EAAAK,QAAA,YAAAA,CAAA;IAAA,OAAAP,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAAuC,SAAAQ,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAL,wBAAAK,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAK,OAAA,EAAAL,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,IAAAH,MAAA,CAAAI,SAAA,CAAAC,cAAA,CAAAC,IAAA,CAAAjB,CAAA,EAAAc,CAAA,SAAAI,CAAA,GAAAR,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAI,CAAA,KAAAA,CAAA,CAAAX,GAAA,IAAAW,CAAA,CAAAC,GAAA,IAAAR,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAI,CAAA,IAAAV,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,YAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAgB,GAAA,CAAAnB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAAA,SAAAhB,uBAAA4B,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAhB,UAAA,GAAAgB,GAAA,KAAAf,OAAA,EAAAe,GAAA;AAGvC;AACO,MAAMC,cAAc,GAAAC,OAAA,CAAAD,cAAA,GAAG,eAAe;;AAE7C;AACO,SAASE,sBAAsBA,CACpCC,WAAmB,EACnBC,eAAuB,EACsB;EAC7C,MAAMC,mBAAmB,GAAGC,sBAAW,CAACC,MAAM,CAACJ,WAAW,EAAE,GAAGC,eAAe,eAAe,CAAC;EAC9F,MAAMI,wBAAwB,GAAGF,sBAAW,CAACC,MAAM,CAACJ,WAAW,EAAEC,eAAe,CAAC;EACjF,MAAMK,WAAW,GAAG,CAAC,EAAEJ,mBAAmB,IAAIG,wBAAwB,CAAC;EAEvE,SAASE,mBAAmBA,CAAA,EAAU;IACpC,MAAM,KAAIC,qBAAW,EACnB,wCAAwCP,eAAe,kBAAkBD,WAAW,GAAG,EACvF,kBACF,CAAC;EACH;EACA,IAAI,CAACM,WAAW,EAAE;IAChBC,mBAAmB,CAAC,CAAC;EACvB;EACA;EACA;EACA,IAAIE,+BAA+B,CAACR,eAAe,CAAC,IAAII,wBAAwB,EAAE;IAChF,OAAO;MAAEK,YAAY,EAAE,KAAK;MAAEC,QAAQ,EAAEN;IAAyB,CAAC;EACpE;EACA,IAAI,CAACH,mBAAmB,EAAE;IACxBK,mBAAmB,CAAC,CAAC;EACvB;EACA,MAAMK,mBAAmB,GAAGC,YAAY,CAACX,mBAAmB,CAAC;EAC7D,IAAIU,mBAAmB,EAAE;IACvB,OAAO;MAAEF,YAAY,EAAE,IAAI;MAAEC,QAAQ,EAAEC;IAAoB,CAAC;EAC9D,CAAC,MAAM;IACL,IAAI,CAACP,wBAAwB,EAAE;MAC7BE,mBAAmB,CAAC,CAAC;IACvB;IACA,OAAO;MAAEG,YAAY,EAAE,KAAK;MAAEC,QAAQ,EAAEN;IAAyB,CAAC;EACpE;AACF;;AAEA;AACA,SAASS,cAAcA,CAACC,IAAY,EAAW;EAC7C;EACA,OAAO,CAAC,CAACA,IAAI,CAACC,KAAK,CAAC,eAAe,CAAC;AACtC;AAEO,SAASP,+BAA+BA,CAACM,IAAY,EAAW;EACrE,IAAID,cAAc,CAACC,IAAI,CAAC,EAAE;IACxB,OAAO,IAAI;EACb;EAEA,MAAME,UAAU,GAAGF,IAAI,CAACG,KAAK,CAAChD,IAAI,CAAD,CAAC,CAACiD,GAAG,CAAC,EAAEC,MAAM;EAC/C;EACA,IAAIL,IAAI,CAACM,UAAU,CAAC,GAAG,CAAC,EAAE;IACxB,OAAOJ,UAAU,GAAG,CAAC;EACvB;;EAEA;EACA,OAAOA,UAAU,GAAG,CAAC;AACvB;AAEA,SAASK,qBAAqBA,CAACC,IAAY,EAAiB;EAC1D;EACA,MAAMC,gBAAgB,GAAGrB,sBAAW,CAACC,MAAM,CACzCmB,IAAI;EACJ;EACA,KAAK1B,cAAc,EACrB,CAAC;;EAED;EACA,IAAI2B,gBAAgB,IAAI,IAAAC,qBAAU,EAACD,gBAAgB,CAAC,EAAE;IACpD,OAAOA,gBAAgB;EACzB;EACA,OAAO,IAAI;AACb;AAEA,SAASX,YAAYA,CAACa,mBAA2B,EAAiB;EAChE;EACA,MAAMC,UAAU,GAAGzD,IAAI,CAAD,CAAC,CAAC0D,OAAO,CAACF,mBAAmB,CAAC;EACpD;EACA,OAAOJ,qBAAqB,CAACK,UAAU,CAAC;AAC1C;AAEO,SAASE,qBAAqBA,CAACC,MAA4C,EAAgB;EAChG,IAAIC,KAAK,CAACC,OAAO,CAACF,MAAM,CAAC,EAAE;IACzB,IAAAG,iBAAM,EACJH,MAAM,CAACV,MAAM,GAAG,CAAC,IAAIU,MAAM,CAACV,MAAM,GAAG,CAAC,EACtC,4FAA4FU,MAAM,CAACV,MAAM,EAC3G,CAAC;IACD,OAAOU,MAAM;EACf;EACA,OAAO,CAACA,MAAM,EAAEI,SAAS,CAAC;AAC5B;AAEO,SAASC,yBAAyBA,CAACnC,WAAoB,EAAuB;EACnF,IAAAiC,iBAAM,EACJjC,WAAW,EACX,wFACF,CAAC;AACH;;AAEA;AACO,SAASoC,2BAA2BA,CAACpC,WAAmB,EAAEC,eAAuB,EAAE;EACxF,MAAM;IAAE6B;EAAO,CAAC,GAAGO,mCAAmC,CAACrC,WAAW,EAAEC,eAAe,CAAC;EACpF,OAAO6B,MAAM;AACf;;AAEA;AACO,SAASO,mCAAmCA,CAACrC,WAAmB,EAAEC,eAAuB,EAAE;EAChG,MAAM;IAAEU,QAAQ,EAAE2B,UAAU;IAAE5B;EAAa,CAAC,GAAGX,sBAAsB,CACnEC,WAAW,EACXC,eACF,CAAC;EACD,IAAIsC,MAAW;EACf,IAAI;IACFA,MAAM,GAAGC,iBAAiB,CAACF,UAAU,CAAC;EACxC,CAAC,CAAC,OAAOG,KAAK,EAAE;IACd,IAAIA,KAAK,YAAYC,WAAW,EAAE;MAChC,MAAMC,aAAa,GAAG,4EAA4E;MAClG;MACA,IAAI,CAACjC,YAAY,IAAI,CAACD,+BAA+B,CAACR,eAAe,CAAC,EAAE;QACtE,MAAM2C,WAAW,GAAG,KAAIpC,qBAAW,EACjC,YAAYP,eAAe,8CAA8C0C,aAAa,OAAOF,KAAK,CAACI,OAAO,EAAE,EAC5G,uBACF,CAAC;QACDD,WAAW,CAACE,KAAK,GAAGL,KAAK,CAACK,KAAK;QAC/B,MAAMF,WAAW;MACnB;IACF;IACA,MAAMH,KAAK;EACb;EAEA,MAAMX,MAAM,GAAGiB,yBAAyB,CAAC;IACvCjB,MAAM,EAAES,MAAM;IACdD,UAAU;IACVrC,eAAe;IACfS;EACF,CAAC,CAAC;EACF,OAAO;IAAEoB,MAAM;IAAEQ,UAAU;IAAErC,eAAe;IAAES;EAAa,CAAC;AAC9D;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASqC,yBAAyBA,CAAC;EACxCjB,MAAM;EACNQ,UAAU;EACVrC,eAAe;EACfS;AAMF,CAAC,EAAyB;EACxB,IAAIoB,MAAM,CAACjD,OAAO,IAAI,IAAI,EAAE;IAC1BiD,MAAM,GAAGA,MAAM,CAACjD,OAAO;EACzB;EACA,IAAI,OAAOiD,MAAM,KAAK,UAAU,EAAE;IAChC,MAAMa,aAAa,GAAG,4EAA4E;IAClG;IACA,IAAI,CAACjC,YAAY,IAAI,CAACD,+BAA+B,CAACR,eAAe,CAAC,EAAE;MACtE,MAAM,KAAIO,qBAAW,EACnB,YAAYP,eAAe,sFAAsFqC,UAAU,KAAKK,aAAa,EAAE,EAC/I,qBACF,CAAC;IACH;IACA,MAAM,KAAInC,qBAAW,EACnB,WAAWP,eAAe,uCAAuCqC,UAAU,KAAKK,aAAa,EAAE,EAC/F,qBACF,CAAC;EACH;EAEA,OAAOb,MAAM;AACf;AAEA,SAASU,iBAAiBA,CAAC7B,QAAgB,EAAO;EAChD,IAAI;IACF,OAAO1C,OAAO,CAAC0C,QAAQ,CAAC;EAC1B,CAAC,CAAC,OAAO8B,KAAK,EAAE;IACd;IACA,MAAMA,KAAK;EACb;AACF","ignoreList":[]}